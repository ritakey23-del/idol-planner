<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>è¿½æ˜Ÿè¡Œç¨‹èˆ‡è¨˜å¸³ App</title>
    <!-- è¼‰å…¥ Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- è¼‰å…¥ Vue 3 -->
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <!-- è¼‰å…¥ Google Fonts -->
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap');
        
        body {
            font-family: 'Inter', sans-serif;
            background-color: #e5e7eb; /* å¤–éƒ¨èƒŒæ™¯æ·±ä¸€é»ï¼Œå‡¸é¡¯æ‰‹æ©Ÿæ¡† */
            height: 100vh;
            margin: 0;
            display: flex;
            justify-content: center;
            overflow: hidden;
        }

        /* éš±è— Scrollbar ä½†ä¿ç•™åŠŸèƒ½ */
        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }
        .no-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }

        /* æ‰‹æ©Ÿæ¨¡æ“¬å®¹å™¨ */
        #app-container {
            width: 100%;
            max-width: 480px; /* æ‰‹æ©Ÿæœ€å¤§å¯¬åº¦ */
            height: 100%;
            display: flex;
            flex-direction: column;
            background-color: #fafafa;
            position: relative;
            box-shadow: 0 0 20px rgba(0,0,0,0.1);
        }

        /* è‡ªå®šç¾©é¡è‰²è®Šæ•¸ */
        :root {
            --color-idol: #63b3b0;
            --color-idol-dark: #4a8f8c;
            --color-idol-light: #84c7c5;
        }

        /* Modal å‹•ç•« */
        .modal-enter-active, .modal-leave-active {
            transition: opacity 0.2s ease;
        }
        .modal-enter-from, .modal-leave-to {
            opacity: 0;
        }
        
        /* Checkbox æ¨£å¼ */
        input[type="checkbox"]:checked {
            background-color: var(--color-idol);
            border-color: var(--color-idol);
        }
    </style>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        idol: {
                            DEFAULT: '#63b3b0',
                            dark: '#4a8f8c',
                            light: '#84c7c5',
                            bg: '#eef7f6'
                        }
                    }
                }
            }
        }
    </script>
</head>
<body>

<div id="app" class="w-full flex justify-center h-full">
    <div id="app-container">
        
        <!-- é ‚éƒ¨å°èˆªæ¬„ -->
        <header class="bg-idol text-white pt-8 pb-4 px-6 shadow-md z-20 shrink-0">
            <div class="flex justify-between items-center mb-4">
                <div>
                    <h1 class="text-2xl font-bold tracking-wide">{{ singerName }}</h1>
                    <p class="text-idol-bg text-xs opacity-90">è¿½æ˜Ÿæ—¥è¨˜ & è¡Œç¨‹åŠ©æ‰‹</p>
                </div>
                <button @click="showSettings = true" class="p-2 bg-white/20 rounded-full hover:bg-white/30 transition">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path></svg>
                </button>
            </div>

            <!-- Tab åˆ‡æ› -->
            <div class="flex bg-idol-dark/30 p-1 rounded-xl">
                <button v-for="tab in tabs" :key="tab.id" 
                    @click="currentTab = tab.id"
                    :class="['flex-1 py-2 text-sm font-medium rounded-lg transition-all duration-300', currentTab === tab.id ? 'bg-white text-idol shadow-sm' : 'text-white hover:bg-white/10']">
                    {{ tab.name }}
                </button>
            </div>
        </header>

        <!-- ä¸»è¦å…§å®¹å€ (å¯æ»¾å‹•) -->
        <main class="flex-1 overflow-y-auto no-scrollbar p-4 pb-24 bg-gray-50 relative">
            
            <!-- 1. è¡Œç¨‹è¡¨è¦–åœ– -->
            <div v-if="currentTab === 'schedule'" class="space-y-4">
                
                <!-- æ´»å‹•é¸æ“‡ Dropdown -->
                <div class="bg-white p-3 rounded-2xl shadow-sm border border-gray-100 flex items-center justify-between sticky top-0 z-10">
                    <div class="flex-1">
                        <label class="text-xs text-gray-400 block ml-1 mb-1">ç•¶å‰æ´»å‹•</label>
                        <select v-model="currentActivityId" class="w-full bg-transparent font-bold text-gray-800 outline-none text-sm sm:text-base">
                            <option v-for="act in activities" :value="act.id">{{ act.name }} ({{ act.year }})</option>
                        </select>
                    </div>
                    <button @click="showActivityModal = true" class="text-idol p-2 hover:bg-idol-bg rounded-full transition">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path></svg>
                    </button>
                </div>

                <!-- è¡Œç¨‹åˆ—è¡¨ -->
                <div v-if="currentActivity">
                    <div class="flex justify-between items-end mb-2 px-1">
                        <span class="text-sm text-gray-500 font-medium">{{ currentActivity.date }}</span>
                        <button @click="openScheduleForm()" class="text-xs bg-idol text-white px-3 py-1.5 rounded-full shadow-sm hover:bg-idol-dark transition flex items-center">
                            <svg class="w-3 h-3 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path></svg> æ–°å¢è¡Œç¨‹
                        </button>
                    </div>

                    <div v-if="currentActivity.schedules.length === 0" class="text-center py-10 text-gray-400">
                        <svg class="w-12 h-12 mx-auto mb-2 opacity-50" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path></svg>
                        <p>é‚„æ²’æœ‰è¡Œç¨‹ï¼Œå¿«ä¾†å®‰æ’å§ï¼</p>
                    </div>

                    <div class="space-y-3 relative">
                        <!-- é€£æ¥ç·š -->
                        <div class="absolute left-[19px] top-4 bottom-4 w-0.5 bg-gray-200 z-0" v-if="currentActivity.schedules.length > 1"></div>

                        <div v-for="(item, idx) in sortedSchedules" :key="item.id" class="relative z-10 group">
                            <div class="flex items-start">
                                <!-- æ™‚é–“è»¸é» -->
                                <div class="w-10 flex-shrink-0 flex flex-col items-center pt-1">
                                    <div class="w-3 h-3 rounded-full border-2 border-white shadow-sm ring-2 ring-transparent transition-all" :class="idx === 0 ? 'bg-idol ring-idol/30' : 'bg-gray-300'"></div>
                                </div>
                                
                                <!-- å¡ç‰‡ -->
                                <div class="flex-1 bg-white p-4 rounded-xl shadow-sm border border-gray-100 hover:shadow-md transition-shadow">
                                    <div class="flex justify-between items-start">
                                        <div>
                                            <span class="text-idol font-bold text-sm block mb-0.5">{{ item.time }}</span>
                                            <h3 class="font-bold text-gray-800 text-base">{{ item.title }}</h3>
                                        </div>
                                        <div class="flex space-x-2">
                                            <button @click="openScheduleForm(item)" class="text-gray-300 hover:text-idol p-1">
                                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z"></path></svg>
                                            </button>
                                            <button @click="deleteSchedule(item.id)" class="text-gray-300 hover:text-red-500 p-1">
                                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                                            </button>
                                        </div>
                                    </div>
                                    
                                    <!-- åœ°é»èˆ‡å°èˆª -->
                                    <div v-if="item.location" class="mt-2 flex items-center text-xs text-gray-500 bg-gray-50 p-2 rounded-lg cursor-pointer hover:bg-idol-bg hover:text-idol-dark transition group/loc" @click="openMap(item.location)">
                                        <svg class="w-3.5 h-3.5 mr-1.5 flex-shrink-0 text-gray-400 group-hover/loc:text-idol" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"></path></svg>
                                        <span class="truncate">{{ item.location }}</span>
                                        <span class="ml-auto text-idol font-bold opacity-0 group-hover/loc:opacity-100 transition-opacity">å°èˆª ></span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div v-else class="text-center py-10 text-gray-400">
                    è«‹å…ˆå»ºç«‹ä¸€å€‹æ´»å‹•
                </div>
            </div>

            <!-- 2. è¨˜å¸³ç³»çµ±è¦–åœ– -->
            <div v-if="currentTab === 'accounting'" class="space-y-6">
                
                <!-- ç¸½è¦½å¡ç‰‡ -->
                <div class="bg-gradient-to-br from-idol to-idol-dark text-white p-5 rounded-2xl shadow-lg relative overflow-hidden">
                    <div class="relative z-10">
                        <p class="text-idol-bg text-sm font-medium opacity-90">æœ¬æ¬¡æ´»å‹•ç¸½æ”¯å‡º</p>
                        <h2 class="text-3xl font-bold mt-1 tracking-tight">$ {{ formatMoney(totalExpense) }}</h2>
                        <div class="mt-4 flex gap-2">
                            <span class="text-xs bg-white/20 px-2 py-1 rounded backdrop-blur-sm">äººæ•¸: {{ participants.length }}</span>
                            <span class="text-xs bg-white/20 px-2 py-1 rounded backdrop-blur-sm">äººå‡: $ {{ formatMoney(participants.length ? totalExpense / participants.length : 0) }}</span>
                        </div>
                    </div>
                    <!-- è£é£¾åœ“åœˆ -->
                    <div class="absolute -right-4 -bottom-8 w-32 h-32 bg-white/10 rounded-full blur-2xl"></div>
                </div>

                <!-- åˆ†å¸³çµæœ -->
                <div v-if="debts.length > 0" class="bg-white rounded-2xl shadow-sm border border-gray-100 p-4">
                    <h3 class="font-bold text-gray-800 mb-3 flex items-center text-sm">
                        <svg class="w-4 h-4 mr-1 text-idol" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 7h6m0 10v-3m-3 3h.01M9 17h.01M9 14h.01M12 14h.01M15 11h.01M12 11h.01M9 11h.01M7 21h10a2 2 0 002-2V5a2 2 0 00-2-2H7a2 2 0 00-2 2v14a2 2 0 002 2z"></path></svg>
                        çµç®— (èª°çµ¦èª°éŒ¢)
                    </h3>
                    <div class="space-y-2">
                        <div v-for="(debt, i) in debts" :key="i" class="flex items-center justify-between text-sm p-2 bg-gray-50 rounded-lg">
                            <div class="flex items-center">
                                <span class="font-bold text-gray-800">{{ debt.from }}</span>
                                <span class="text-gray-400 mx-2 text-xs">çµ¦</span>
                                <span class="font-bold text-idol-dark">{{ debt.to }}</span>
                            </div>
                            <span class="font-bold text-gray-700">$ {{ formatMoney(debt.amount) }}</span>
                        </div>
                    </div>
                </div>

                <!-- è¨˜å¸³åˆ—è¡¨ -->
                <div>
                    <div class="flex justify-between items-center mb-2 px-1">
                        <h3 class="font-bold text-gray-700 text-sm">æ”¯å‡ºæ˜ç´°</h3>
                        <button @click="openExpenseModal" class="text-xs text-idol font-bold border border-idol px-3 py-1 rounded-full hover:bg-idol hover:text-white transition flex items-center">
                            <span class="text-lg leading-none mr-0.5 mb-0.5">+</span> è¨˜ä¸€ç­†
                        </button>
                    </div>
                    
                    <div class="space-y-3 pb-20">
                        <div v-for="exp in expenses" :key="exp.id" class="bg-white p-3 rounded-xl shadow-sm border border-gray-100 flex justify-between items-center">
                            <div>
                                <p class="font-bold text-gray-800 text-sm">{{ exp.item }}</p>
                                <p class="text-xs text-gray-500 mt-0.5"><span class="bg-gray-100 px-1.5 py-0.5 rounded text-gray-600">{{ exp.payer }}</span> å…ˆä»˜</p>
                            </div>
                            <div class="text-right flex items-center">
                                <p class="font-bold text-idol mr-3">$ {{ formatMoney(exp.amount) }}</p>
                                <button @click="deleteExpense(exp.id)" class="text-gray-300 hover:text-red-400 p-1">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                                </button>
                            </div>
                        </div>
                         <div v-if="expenses.length === 0" class="text-center py-8 text-gray-400 text-sm bg-white rounded-xl border border-dashed border-gray-200">
                            å°šæœªæœ‰ä»»ä½•æ”¯å‡ºç´€éŒ„
                        </div>
                    </div>
                </div>

                <!-- æˆå“¡ç®¡ç† (å›ºå®šåœ¨åº•éƒ¨) -->
                <div class="fixed bottom-0 left-0 w-full flex justify-center pointer-events-none z-10">
                    <div class="w-full max-w-[480px] bg-white p-3 rounded-t-2xl shadow-[0_-4px_6px_-1px_rgba(0,0,0,0.1)] border-t border-gray-100 pointer-events-auto">
                        <div class="flex justify-between items-center mb-2">
                             <h3 class="font-bold text-gray-700 text-xs">åˆ†å¸³æˆå“¡</h3>
                        </div>
                        <div class="flex flex-wrap gap-2 items-center">
                            <div v-for="(p, idx) in participants" :key="idx" class="bg-idol-bg text-idol-dark text-xs px-3 py-1.5 rounded-full font-medium flex items-center shadow-sm">
                                {{ p }}
                                <button @click="removeParticipant(idx)" class="ml-1.5 hover:text-red-500 font-bold">Ã—</button>
                            </div>
                            <div class="flex items-center">
                                <input v-model="newParticipant" @keyup.enter="addParticipant" type="text" placeholder="åŠ äºº..." class="text-xs bg-gray-100 border-none rounded-full px-3 py-1.5 w-20 outline-none focus:ring-1 focus:ring-idol transition-all focus:w-24">
                                <button @click="addParticipant" class="ml-1 text-idol hover:text-idol-dark p-1">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path></svg>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 3. å¹´åº¦å›é¡§è¦–åœ– -->
            <div v-if="currentTab === 'review'" class="space-y-4">
                <h2 class="text-lg font-bold text-gray-800 px-1">å¹´åº¦è¿½æ˜Ÿç¸½çµ</h2>
                
                <div v-for="(yearData, year) in yearlySummary" :key="year" class="bg-white rounded-2xl shadow-sm border border-gray-100 overflow-hidden">
                    <div class="bg-idol-bg p-3 flex justify-between items-center">
                        <span class="font-bold text-idol-dark text-lg flex items-center">
                            <svg class="w-5 h-5 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path></svg>
                            {{ year }} å¹´
                        </span>
                        <span class="text-xs bg-white text-idol px-2 py-0.5 rounded-md font-bold shadow-sm">{{ yearData.count }} å ´æ´»å‹•</span>
                    </div>
                    <div class="p-4">
                        <div class="relative pl-4 border-l-2 border-gray-100 space-y-5">
                            <div v-for="act in yearData.activities" :key="act.id" class="relative">
                                <div class="absolute -left-[21px] top-1.5 w-3 h-3 bg-idol rounded-full border-2 border-white ring-2 ring-gray-50"></div>
                                <h4 class="font-bold text-gray-800 text-sm">{{ act.name }}</h4>
                                <p class="text-xs text-gray-500 font-mono mt-0.5">{{ act.date }}</p>
                                <div class="mt-1 flex flex-wrap gap-1">
                                     <span class="text-[10px] bg-gray-100 text-gray-500 px-1.5 py-0.5 rounded" v-if="act.schedules.length > 0">
                                        ğŸ“ {{ Array.from(new Set(act.schedules.map(s=>s.location).filter(l=>l))).length }} åœ°é»
                                     </span>
                                     <span class="text-[10px] bg-gray-100 text-gray-500 px-1.5 py-0.5 rounded" v-if="act.schedules.length > 0">
                                        ğŸ“ {{ act.schedules.length }} è¡Œç¨‹
                                     </span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div v-if="Object.keys(yearlySummary).length === 0" class="text-center py-10 text-gray-400">
                    <p>ç´¯ç©è¶³è·¡å¾Œï¼Œé€™è£¡æœƒé¡¯ç¤ºå¹´åº¦å›é¡§å–”ï¼</p>
                </div>
            </div>

        </main>
    </div>

    <!-- Modals -->
    
    <!-- 1. æ–°å¢/ç·¨è¼¯è¡Œç¨‹ Modal -->
    <transition name="modal">
    <div v-if="showScheduleModal" class="fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4 backdrop-blur-sm">
        <div class="bg-white w-full max-w-xs rounded-2xl shadow-2xl p-6 transform transition-all scale-100">
            <h3 class="text-xl font-bold text-gray-800 mb-4">{{ editingScheduleId ? 'ç·¨è¼¯è¡Œç¨‹' : 'æ–°å¢è¡Œç¨‹' }}</h3>
            <div class="space-y-3">
                <div>
                    <label class="text-xs text-gray-500 font-bold block mb-1">æ™‚é–“</label>
                    <input v-model="scheduleForm.time" type="time" class="w-full bg-gray-50 border border-gray-200 rounded-xl p-3 outline-none focus:border-idol focus:ring-1 focus:ring-idol transition">
                </div>
                <div>
                    <label class="text-xs text-gray-500 font-bold block mb-1">æ´»å‹•å…§å®¹</label>
                    <input v-model="scheduleForm.title" type="text" placeholder="ä¾‹ï¼šæ’éšŠé€²å ´" class="w-full bg-gray-50 border border-gray-200 rounded-xl p-3 outline-none focus:border-idol focus:ring-1 focus:ring-idol transition">
                </div>
                <div>
                    <label class="text-xs text-gray-500 font-bold block mb-1">åœ°é»</label>
                    <input v-model="scheduleForm.location" type="text" placeholder="ä¾‹ï¼šå°åŒ—å°å·¨è›‹ (å¯å°èˆª)" class="w-full bg-gray-50 border border-gray-200 rounded-xl p-3 outline-none focus:border-idol focus:ring-1 focus:ring-idol transition">
                </div>
            </div>
            <div class="flex gap-3 mt-6">
                <button @click="showScheduleModal = false" class="flex-1 py-3 text-gray-500 font-bold rounded-xl bg-gray-100 hover:bg-gray-200 transition">å–æ¶ˆ</button>
                <button @click="saveSchedule" class="flex-1 py-3 bg-idol text-white font-bold rounded-xl shadow-lg shadow-idol/30 hover:bg-idol-dark transition transform active:scale-95">å„²å­˜</button>
            </div>
        </div>
    </div>
    </transition>

    <!-- 2. è¨˜å¸³ Modal -->
    <transition name="modal">
    <div v-if="showExpenseModal" class="fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4 backdrop-blur-sm">
        <div class="bg-white w-full max-w-xs rounded-2xl shadow-2xl p-6">
            <h3 class="text-xl font-bold text-gray-800 mb-4">è¨˜ä¸€ç­†æ”¯å‡º</h3>
            <div class="space-y-3">
                <div>
                    <label class="text-xs text-gray-500 font-bold block mb-1">é …ç›®</label>
                    <input v-model="expenseForm.item" type="text" placeholder="ä¾‹ï¼šæ™šé¤ã€è¨ˆç¨‹è»Š" class="w-full bg-gray-50 border border-gray-200 rounded-xl p-3 outline-none focus:border-idol focus:ring-1 focus:ring-idol transition">
                </div>
                <div>
                    <label class="text-xs text-gray-500 font-bold block mb-1">é‡‘é¡</label>
                    <input v-model.number="expenseForm.amount" type="number" placeholder="0" class="w-full bg-gray-50 border border-gray-200 rounded-xl p-3 outline-none focus:border-idol focus:ring-1 focus:ring-idol transition">
                </div>
                <div>
                    <label class="text-xs text-gray-500 font-bold block mb-1">èª°å…ˆå¢Šä»˜ï¼Ÿ</label>
                    <select v-model="expenseForm.payer" class="w-full bg-gray-50 border border-gray-200 rounded-xl p-3 outline-none focus:border-idol focus:ring-1 focus:ring-idol transition appearance-none">
                        <option v-for="p in participants" :value="p">{{ p }}</option>
                    </select>
                </div>
            </div>
            <div class="flex gap-3 mt-6">
                <button @click="showExpenseModal = false" class="flex-1 py-3 text-gray-500 font-bold rounded-xl bg-gray-100 hover:bg-gray-200 transition">å–æ¶ˆ</button>
                <button @click="addExpense" class="flex-1 py-3 bg-idol text-white font-bold rounded-xl shadow-lg shadow-idol/30 hover:bg-idol-dark transition transform active:scale-95">æ–°å¢</button>
            </div>
        </div>
    </div>
    </transition>

    <!-- 3. è¨­å®š & æ´»å‹•ç®¡ç† Modal -->
    <transition name="modal">
    <div v-if="showSettings" class="fixed inset-0 bg-black/50 z-50 flex items-end sm:items-center justify-center backdrop-blur-sm">
        <div class="bg-white w-full max-w-[480px] sm:max-w-xs sm:rounded-2xl rounded-t-2xl shadow-2xl p-6 h-[85vh] sm:h-auto overflow-y-auto">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-xl font-bold text-gray-800">App è¨­å®š</h3>
                <button @click="showSettings = false" class="p-2 bg-gray-100 rounded-full hover:bg-gray-200 transition">
                    <svg class="w-4 h-4 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                </button>
            </div>
            
            <div class="space-y-6">
                <!-- æ­Œæ‰‹è¨­å®š -->
                <div class="bg-gray-50 p-4 rounded-xl border border-gray-100">
                    <label class="block text-xs font-bold text-gray-400 uppercase mb-2">æœ¬å‘½æ­Œæ‰‹/åœ˜é«”</label>
                    <input v-model="singerName" type="text" class="w-full bg-transparent border-b-2 border-gray-200 py-1 outline-none focus:border-idol text-lg font-bold text-idol-dark transition">
                </div>

                <!-- æ´»å‹•ç®¡ç† -->
                <div>
                    <div class="flex justify-between items-center mb-3">
                        <label class="block text-sm font-bold text-gray-700">æˆ‘çš„è¡Œç¨‹åˆ—è¡¨</label>
                        <button @click="showActivityModal = true; showSettings = false" class="text-xs bg-idol text-white px-3 py-1.5 rounded-full font-bold shadow hover:bg-idol-dark transition">+ æ–°å¢æ´»å‹•</button>
                    </div>
                    <div class="space-y-2 max-h-60 overflow-y-auto pr-1">
                        <div v-for="act in activities" :key="act.id" class="flex justify-between items-center bg-white p-3 rounded-xl border border-gray-100 shadow-sm">
                            <div @click="switchActivity(act.id)" class="cursor-pointer flex-1">
                                <p class="text-sm font-bold text-gray-800" :class="{'text-idol': currentActivityId === act.id}">{{ act.name }}</p>
                                <p class="text-xs text-gray-500">{{ act.date }}</p>
                            </div>
                            <button @click="deleteActivity(act.id)" class="text-gray-300 hover:text-red-500 p-2">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- æ¸…é™¤è³‡æ–™æŒ‰éˆ• -->
                <div class="pt-4 border-t border-gray-100 text-center">
                    <button @click="resetData" class="text-xs text-red-300 underline hover:text-red-500">é‡ç½®æ‰€æœ‰è³‡æ–™ (ç„¡æ³•å¾©åŸ)</button>
                    <p class="text-[10px] text-gray-300 mt-2">Data stored locally on device</p>
                </div>
            </div>
        </div>
    </div>
    </transition>

    <!-- 4. æ–°å¢æ´»å‹• Modal -->
    <transition name="modal">
    <div v-if="showActivityModal" class="fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4 backdrop-blur-sm">
        <div class="bg-white w-full max-w-xs rounded-2xl shadow-2xl p-6">
            <h3 class="text-xl font-bold text-gray-800 mb-4">å»ºç«‹æ–°æ´»å‹•</h3>
            <div class="space-y-3">
                <div>
                    <label class="text-xs text-gray-500 font-bold block mb-1">æ´»å‹•åç¨±</label>
                    <input v-model="newActivityForm.name" type="text" placeholder="ä¾‹ï¼šå°åŒ—å°å·¨è›‹æ¼”å”±æœƒ" class="w-full bg-gray-50 border border-gray-200 rounded-xl p-3 outline-none focus:border-idol focus:ring-1 focus:ring-idol transition">
                </div>
                <div>
                    <label class="text-xs text-gray-500 font-bold block mb-1">æ—¥æœŸ</label>
                    <input v-model="newActivityForm.date" type="date" class="w-full bg-gray-50 border border-gray-200 rounded-xl p-3 outline-none focus:border-idol focus:ring-1 focus:ring-idol transition">
                </div>
            </div>
            <div class="flex gap-3 mt-6">
                <button @click="showActivityModal = false" class="flex-1 py-3 text-gray-500 font-bold rounded-xl bg-gray-100 hover:bg-gray-200 transition">å–æ¶ˆ</button>
                <button @click="addActivity" class="flex-1 py-3 bg-idol text-white font-bold rounded-xl shadow-lg shadow-idol/30 hover:bg-idol-dark transition transform active:scale-95">å»ºç«‹</button>
            </div>
        </div>
    </div>
    </transition>

</div>

<script>
    const { createApp, ref, computed, reactive, watch, onMounted } = Vue;

    createApp({
        setup() {
            // LocalStorage Key
            const STORAGE_KEY = 'idol_planner_v2';

            // åŸºæœ¬è³‡æ–™
            const singerName = ref('IU');
            const currentTab = ref('schedule');
            const tabs = [
                { id: 'schedule', name: 'è¡Œç¨‹' },
                { id: 'accounting', name: 'è¨˜å¸³' },
                { id: 'review', name: 'å›é¡§' }
            ];

            // é è¨­è³‡æ–™
            const defaultActivities = [
                { 
                    id: 1, 
                    name: 'é¦–çˆ¾å®‰å¯å ´', 
                    date: '2024-03-02', 
                    year: '2024',
                    schedules: [
                        { id: 101, time: '10:00', title: 'æŠµé”ä»å·æ©Ÿå ´', location: 'Incheon Airport' },
                        { id: 102, time: '14:00', title: 'é ˜å–ç¥¨åˆ¸ & å‘¨é‚Š', location: 'KSPO DOME' },
                        { id: 103, time: '18:00', title: 'æ¼”å”±æœƒé–‹å§‹', location: 'KSPO DOME' }
                    ]
                }
            ];

            const activities = ref([]);
            const currentActivityId = ref(null);

            // è¨˜å¸³è³‡æ–™
            const participants = ref(['æˆ‘', 'æœ‹å‹A']);
            const newParticipant = ref('');
            const expenses = ref([]);

            // UI ç‹€æ…‹
            const showSettings = ref(false);
            const showScheduleModal = ref(false);
            const showExpenseModal = ref(false);
            const showActivityModal = ref(false);

            // è¡¨å–®
            const scheduleForm = reactive({ time: '', title: '', location: '' });
            const editingScheduleId = ref(null);
            const expenseForm = reactive({ item: '', amount: '', payer: '' });
            const newActivityForm = reactive({ name: '', date: '' });

            // --- è³‡æ–™å­˜å–é‚è¼¯ ---
            
            const loadData = () => {
                const saved = localStorage.getItem(STORAGE_KEY);
                if (saved) {
                    try {
                        const data = JSON.parse(saved);
                        singerName.value = data.singerName || 'IU';
                        activities.value = data.activities || defaultActivities;
                        participants.value = data.participants || ['æˆ‘', 'æœ‹å‹A'];
                        expenses.value = data.expenses || [];
                    } catch (e) {
                        console.error("è³‡æ–™æå£ï¼Œé‡ç½®ç‚ºé è¨­å€¼");
                        activities.value = defaultActivities;
                    }
                } else {
                    activities.value = defaultActivities;
                }

                // ç¢ºä¿æœ‰ä¸€å€‹é¸ä¸­çš„æ´»å‹•
                if (activities.value.length > 0 && !currentActivityId.value) {
                    currentActivityId.value = activities.value[0].id;
                }
            };

            const saveData = () => {
                const data = {
                    singerName: singerName.value,
                    activities: activities.value,
                    participants: participants.value,
                    expenses: expenses.value
                };
                localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
            };

            const resetData = () => {
                if(confirm("ç¢ºå®šè¦åˆªé™¤æ‰€æœ‰è³‡æ–™é‡ä¾†å—ï¼Ÿ")) {
                    localStorage.removeItem(STORAGE_KEY);
                    location.reload();
                }
            };

            // è‡ªå‹•å­˜æª”ç›£è½
            watch([singerName, activities, participants, expenses], () => {
                saveData();
            }, { deep: true });

            onMounted(() => {
                loadData();
            });

            // --- Computed ---

            const currentActivity = computed(() => {
                return activities.value.find(a => a.id === currentActivityId.value) || null;
            });

            const sortedSchedules = computed(() => {
                if (!currentActivity.value) return [];
                return [...currentActivity.value.schedules].sort((a, b) => a.time.localeCompare(b.time));
            });

            const totalExpense = computed(() => {
                return expenses.value.reduce((sum, item) => sum + item.amount, 0);
            });

            // åˆ†å¸³æ¼”ç®—æ³•
            const debts = computed(() => {
                if (participants.value.length === 0) return [];
                let balance = {};
                participants.value.forEach(p => balance[p] = 0);
                
                const perPerson = totalExpense.value / participants.value.length;
                
                expenses.value.forEach(exp => {
                    if (balance[exp.payer] !== undefined) {
                        balance[exp.payer] += exp.amount;
                    }
                });
                
                let debtors = [];
                let creditors = [];
                
                for (let p in balance) {
                    let diff = balance[p] - perPerson;
                    if (diff < -0.01) debtors.push({ name: p, amount: -diff });
                    if (diff > 0.01) creditors.push({ name: p, amount: diff });
                }
                
                let result = [];
                let i = 0, j = 0;
                while (i < debtors.length && j < creditors.length) {
                    let amount = Math.min(debtors[i].amount, creditors[j].amount);
                    if (amount > 0) {
                        result.push({
                            from: debtors[i].name,
                            to: creditors[j].name,
                            amount: Math.round(amount)
                        });
                    }
                    debtors[i].amount -= amount;
                    creditors[j].amount -= amount;
                    if (debtors[i].amount < 0.01) i++;
                    if (creditors[j].amount < 0.01) j++;
                }
                return result;
            });

            const yearlySummary = computed(() => {
                const summary = {};
                activities.value.forEach(act => {
                    const year = act.year || act.date.substring(0, 4);
                    if (!summary[year]) summary[year] = { count: 0, activities: [] };
                    summary[year].count++;
                    summary[year].activities.push(act);
                });
                return Object.keys(summary).sort().reverse().reduce((obj, key) => { 
                    obj[key] = summary[key]; 
                    return obj;
                }, {});
            });

            // --- Methods ---

            // è¡Œç¨‹
            const openScheduleForm = (item = null) => {
                if (item) {
                    editingScheduleId.value = item.id;
                    scheduleForm.time = item.time;
                    scheduleForm.title = item.title;
                    scheduleForm.location = item.location;
                } else {
                    editingScheduleId.value = null;
                    scheduleForm.time = '';
                    scheduleForm.title = '';
                    scheduleForm.location = '';
                }
                showScheduleModal.value = true;
            };

            const saveSchedule = () => {
                if (!currentActivity.value) return;
                
                if (editingScheduleId.value) {
                    const idx = currentActivity.value.schedules.findIndex(s => s.id === editingScheduleId.value);
                    if (idx !== -1) {
                        currentActivity.value.schedules[idx] = { 
                            ...currentActivity.value.schedules[idx], 
                            ...scheduleForm 
                        };
                    }
                } else {
                    currentActivity.value.schedules.push({
                        id: Date.now(),
                        ...scheduleForm
                    });
                }
                showScheduleModal.value = false;
            };

            const deleteSchedule = (id) => {
                if (!confirm('ç¢ºå®šåˆªé™¤æ­¤è¡Œç¨‹å—ï¼Ÿ')) return;
                const idx = currentActivity.value.schedules.findIndex(s => s.id === id);
                if (idx !== -1) currentActivity.value.schedules.splice(idx, 1);
            };

            const openMap = (location) => {
                if (!location) return;
                window.open(`https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(location)}`, '_blank');
            };

            // è¨˜å¸³
            const addParticipant = () => {
                if (newParticipant.value && !participants.value.includes(newParticipant.value)) {
                    participants.value.push(newParticipant.value);
                    newParticipant.value = '';
                }
            };
            
            const removeParticipant = (index) => {
                if (confirm('åˆªé™¤æˆå“¡æœƒå½±éŸ¿è¨ˆç®—ï¼Œç¢ºå®šå—ï¼Ÿ')) {
                    participants.value.splice(index, 1);
                }
            };

            const openExpenseModal = () => {
                expenseForm.item = '';
                expenseForm.amount = '';
                expenseForm.payer = participants.value[0] || '';
                showExpenseModal.value = true;
            };

            const addExpense = () => {
                if (!expenseForm.item || !expenseForm.amount || !expenseForm.payer) return;
                expenses.value.push({
                    id: Date.now(),
                    item: expenseForm.item,
                    amount: parseFloat(expenseForm.amount),
                    payer: expenseForm.payer
                });
                showExpenseModal.value = false;
            };

            const deleteExpense = (id) => {
                if (!confirm('ç¢ºå®šåˆªé™¤æ­¤ç­†æ”¯å‡ºï¼Ÿ')) return;
                expenses.value = expenses.value.filter(e => e.id !== id);
            };

            // æ´»å‹•
            const addActivity = () => {
                if (!newActivityForm.name || !newActivityForm.date) return;
                const newId = Date.now();
                activities.value.push({
                    id: newId,
                    name: newActivityForm.name,
                    date: newActivityForm.date,
                    year: newActivityForm.date.substring(0, 4),
                    schedules: []
                });
                currentActivityId.value = newId;
                showActivityModal.value = false;
                newActivityForm.name = '';
                newActivityForm.date = '';
            };

            const deleteActivity = (id) => {
                if (!confirm('åˆªé™¤æ´»å‹•æœƒä¸€ä½µåˆªé™¤è©²æ´»å‹•çš„æ‰€æœ‰è¡Œç¨‹ï¼Œç¢ºå®šå—ï¼Ÿ')) return;
                activities.value = activities.value.filter(a => a.id !== id);
                if (currentActivityId.value === id) {
                    currentActivityId.value = activities.value.length > 0 ? activities.value[0].id : null;
                }
            };

            const switchActivity = (id) => {
                currentActivityId.value = id;
                showSettings.value = false;
            };

            const formatMoney = (val) => Math.round(val).toLocaleString();

            return {
                singerName, currentTab, tabs, activities, currentActivityId, currentActivity, sortedSchedules,
                scheduleForm, editingScheduleId, showScheduleModal, openScheduleForm, saveSchedule, deleteSchedule, openMap,
                participants, newParticipant, expenses, showExpenseModal, expenseForm, openExpenseModal, addExpense, deleteExpense,
                addParticipant, removeParticipant, totalExpense, debts, formatMoney,
                showSettings, showActivityModal, newActivityForm, addActivity, deleteActivity, switchActivity, resetData, yearlySummary
            };
        }
    }).mount('#app');
</script>

</body>
</html>